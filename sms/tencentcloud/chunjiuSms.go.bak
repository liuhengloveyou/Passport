package sms

import (
	"fmt"
	"math/rand"
	"time"

	"club/common"

	"go.uber.org/zap"
)

type ChunjiuScuuessSmsStruct struct {
	PhoneNumber string
	UserSession string

	ShopName       string
	GoodsInfo      string
	UsefulLife     string // 有效期
	ExpirationTime string // 过期时间
}

// 存酒过期通知
// https://console.cloud.tencent.com/smsv2/csms-template
// 1468466: 有存酒即将过期，请您关注。
func SendChunjiuExpireSms(tenantId uint64, phoneNumbers []string) (err error) {
	common.Logger.Info("SendChunjiuExpireSms: %v %v\n", zap.Uint64("tenantId", tenantId), zap.Any("phoneNumbers", phoneNumbers))

	for i := 0; i < 3; i++ {
		if err = sendSms(phoneNumbers, "", "1468466", nil); err != nil {
			common.Logger.Sugar().Errorf("SendChunjiuExpireSms ERR: ", err)
			time.Sleep(time.Second)
		} else {
			break
		}
	}

	return
}

// 存酒成功通知
// https://console.cloud.tencent.com/smsv2/csms-template
// 1288823: {1} 您好。您已成功寄存：{2}。有效期{3}天，请在{4}之前凭本手机号来取。
func SendChunjiuSuccessSms(data *ChunjiuScuuessSmsStruct) (err error) {
	common.Logger.Sugar().Info("SendChunjiuSuccessSms: ", *data)

	for i := 0; i < 3; i++ {
		if err = sendSms([]string{data.PhoneNumber}, data.UserSession, "1288823", []string{data.ShopName, data.GoodsInfo, data.UsefulLife, data.ExpirationTime}); err != nil {
			common.Logger.Sugar().Errorf("SendChunjiuSuccessSms ERR: ", err)
			time.Sleep(time.Second)
		} else {
			break
		}
	}

	return
}

// 取酒验证码
// 1289365 https://console.cloud.tencent.com/smsv2/csms-template
// 验证码为：{1}，您正在取寄存物品，若非本人操作，请勿泄露。
func SendQujiuSms(chunjiuID uint64, phoneNumber string) (code string, err error) {
	code = fmt.Sprintf("%06v", rand.New(rand.NewSource((time.Now().UnixNano()))).Int31n(1000000))
	common.Logger.Sugar().Infof("SendQujiuSms: %v %v %v %v", code, chunjiuID, phoneNumber)

	if err = sendSms([]string{phoneNumber}, fmt.Sprintf("%v", chunjiuID), "1289365", []string{code}); err != nil {
		common.Logger.Sugar().Errorf("SendQujiuSms ERR: %v %v %v %v %v\n", code, chunjiuID, phoneNumber, err)
	}

	return
}
